<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>F1 Race Animator - Live Telemetry Visualization</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #e0e0e0;
            overflow: hidden;
        }

        .container {
            width: 100vw;
            height: 100vh;
            display: flex;
            flex-direction: column;
            gap: 10px;
            padding: 10px;
        }

        .header {
            background: rgba(0, 0, 0, 0.5);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #00d4ff;
            text-align: center;
        }

        .header h1 {
            font-size: 28px;
            color: #00d4ff;
            margin-bottom: 5px;
        }

        .header p {
            font-size: 12px;
            color: #888;
        }

        .main-content {
            display: flex;
            gap: 10px;
            flex: 1;
            min-height: 0;
        }

        .canvas-container {
            flex: 1;
            background: rgba(0, 0, 0, 0.7);
            border: 2px solid #00d4ff;
            border-radius: 8px;
            position: relative;
            overflow: hidden;
        }

        canvas {
            width: 100%;
            height: 100%;
            display: block;
        }

        .sidebar {
            width: 300px;
            background: rgba(0, 0, 0, 0.6);
            border: 1px solid #00d4ff;
            border-radius: 8px;
            padding: 15px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .drivers-list {
            flex: 1;
            overflow-y: auto;
        }

        .driver-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid #00d4ff;
            border-radius: 6px;
            padding: 10px;
            margin-bottom: 8px;
            transition: all 0.3s ease;
        }

        .driver-card:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: #ff6b00;
        }

        .driver-name {
            font-weight: bold;
            color: #00d4ff;
            font-size: 13px;
            margin-bottom: 5px;
        }

        .driver-stat {
            display: flex;
            justify-content: space-between;
            font-size: 11px;
            margin: 3px 0;
            color: #aaa;
        }

        .stat-label {
            color: #888;
        }

        .stat-value {
            color: #fff;
            font-weight: bold;
        }

        .controls-section {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid #00d4ff;
            border-radius: 6px;
            padding: 12px;
        }

        .controls-section h3 {
            font-size: 12px;
            color: #00d4ff;
            margin-bottom: 10px;
            text-transform: uppercase;
        }

        .playback-controls {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        button {
            flex: 1;
            min-width: 60px;
            padding: 8px 12px;
            background: linear-gradient(135deg, #00d4ff, #0099cc);
            border: none;
            border-radius: 4px;
            color: #000;
            font-weight: bold;
            cursor: pointer;
            font-size: 11px;
            transition: all 0.3s ease;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 212, 255, 0.4);
        }

        button:active {
            transform: translateY(0);
        }

        .slider-control {
            margin: 10px 0;
        }

        .slider-label {
            font-size: 11px;
            color: #888;
            margin-bottom: 5px;
            display: flex;
            justify-content: space-between;
        }

        input[type="range"] {
            width: 100%;
            height: 6px;
            background: rgba(0, 212, 255, 0.2);
            border-radius: 3px;
            outline: none;
            -webkit-appearance: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #00d4ff;
            cursor: pointer;
            box-shadow: 0 0 8px rgba(0, 212, 255, 0.6);
        }

        input[type="range"]::-moz-range-thumb {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #00d4ff;
            cursor: pointer;
            border: none;
            box-shadow: 0 0 8px rgba(0, 212, 255, 0.6);
        }

        .time-display {
            background: rgba(0, 0, 0, 0.3);
            padding: 8px;
            border-radius: 4px;
            text-align: center;
            font-size: 12px;
            font-family: 'Courier New', monospace;
            color: #00d4ff;
        }

        .stats {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid #00d4ff;
            border-radius: 6px;
            padding: 8px;
            font-size: 11px;
        }

        .stat-row {
            display: flex;
            justify-content: space-between;
            margin: 4px 0;
            color: #aaa;
        }

        .stat-value-small {
            color: #00d4ff;
            font-weight: bold;
        }

        /* Scrollbar styling */
        .sidebar::-webkit-scrollbar {
            width: 6px;
        }

        .sidebar::-webkit-scrollbar-track {
            background: rgba(0, 212, 255, 0.1);
            border-radius: 3px;
        }

        .sidebar::-webkit-scrollbar-thumb {
            background: rgba(0, 212, 255, 0.4);
            border-radius: 3px;
        }

        .sidebar::-webkit-scrollbar-thumb:hover {
            background: rgba(0, 212, 255, 0.6);
        }

        .fps-counter {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.7);
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 11px;
            color: #00d4ff;
            font-family: 'Courier New', monospace;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üèÅ F1 Race Animator</h1>
            <p>Real-time Driver Position Animation with Telemetry Visualization</p>
        </div>

        <div class="main-content">
            <div class="canvas-container">
                <canvas id="raceCanvas"></canvas>
                <div class="fps-counter" id="fpsCounter">FPS: 0</div>
            </div>

            <div class="sidebar">
                <div class="controls-section">
                    <h3>üì° Session Selector</h3>
                    <select id="sessionSelector" style="width: 100%; padding: 8px; margin-bottom: 10px; border-radius: 4px; background: rgba(0,212,255,0.1); color: #00d4ff; border: 1px solid #00d4ff; cursor: pointer;">
                        <option value="">Loading sessions...</option>
                    </select>
                    <button id="loadSessionBtn" style="width: 100%; margin-bottom: 10px;">Load Session</button>
                </div>

                <div class="controls-section">
                    <h3>üéÆ Playback</h3>
                    <div class="playback-controls">
                        <button id="playBtn" title="Play">‚ñ∂ Play</button>
                        <button id="pauseBtn" title="Pause">‚è∏ Pause</button>
                        <button id="rewindBtn" title="Rewind">‚èÆ Rewind</button>
                    </div>

                    <div class="slider-control">
                        <div class="slider-label">
                            <span>Speed</span>
                            <span id="speedValue">1.0x</span>
                        </div>
                        <input type="range" id="speedSlider" min="0.25" max="100" step="0.25" value="1">
                    </div>

                    <div class="slider-control">
                        <div class="slider-label">
                            <span>Progress</span>
                            <span id="progressValue">0%</span>
                        </div>
                        <input type="range" id="progressSlider" min="0" max="100" value="0">
                    </div>

                    <div class="time-display" id="timeDisplay">00:00 / 00:00</div>
                </div>

                <div class="drivers-list" id="driversList"></div>
            </div>
        </div>
    </div>

    <!-- Track Database -->
    <script src="f1-tracks.js?v=4"></script>

    <!-- Core Modules -->
    <script src="telemetry-loader.js?v=4"></script>
    <script src="interpolator.js?v=4"></script>
    <script src="track-renderer.js?v=4"></script>
    <script src="driver-animator.js?v=4"></script>
    <script src="playback-controller.js?v=4"></script>
    <script src="ui-manager.js?v=4"></script>
    <script src="race-animator.js?v=4"></script>
    <script src="sample-data.js?v=4"></script>
    <script src="openf1-loader.js?v=4"></script>

    <!-- Initialization -->
    <script>
        let animator;
        let openf1Loader;

        // Initialize the animation system on page load
        window.addEventListener('load', async () => {
            animator = new RaceAnimator('raceCanvas');
            animator.initialize();

            // Initialize OpenF1 loader
            openf1Loader = new OpenF1Loader("http://localhost:8001");

            // Load available sessions
            await loadSessions();

            // Try to load sample data first as fallback
            if (window.SAMPLE_TELEMETRY_DATA) {
                await animator.loadTelemetryData(window.SAMPLE_TELEMETRY_DATA);
                animator.start();
            }
        });

        /**
         * Load available sessions and populate dropdown
         */
        async function loadSessions() {
            try {
                const sessions = await openf1Loader.fetchAvailableSessions();

                if (sessions.length === 0) {
                    console.warn("No sessions available from OpenF1 API");
                    return;
                }

                const selector = document.getElementById('sessionSelector');
                selector.innerHTML = '';

                // Filter for October 20 race (session 9608 - 2024 Austin GP Race)
                const raceSession = sessions.find(s => s.session_key === 9608);

                if (raceSession) {
                    const option = document.createElement('option');
                    option.value = raceSession.session_key;

                    const sessionType = raceSession.session_type || 'Race';
                    const date = new Date(raceSession.date).toLocaleDateString('en-US', {
                        month: 'short',
                        day: 'numeric',
                        year: 'numeric'
                    });

                    option.textContent = `${raceSession.session_name} ‚Ä¢ ${sessionType.toUpperCase()} ‚Ä¢ ${date}`;
                    selector.appendChild(option);
                    selector.value = raceSession.session_key;
                } else {
                    // Fallback: show first race session found
                    const raceSessions = sessions.filter(s => s.session_type === 'Race');
                    raceSessions.slice(0, 1).forEach(session => {
                        const option = document.createElement('option');
                        option.value = session.session_key;
                        const sessionType = session.session_type || 'Session';
                        const date = new Date(session.date).toLocaleDateString('en-US', {
                            month: 'short',
                            day: 'numeric',
                            year: 'numeric'
                        });
                        option.textContent = `${session.session_name} ‚Ä¢ ${sessionType.toUpperCase()} ‚Ä¢ ${date}`;
                        selector.appendChild(option);
                    });
                    if (selector.options.length > 0) {
                        selector.value = selector.options[0].value;
                    }
                }

            } catch (error) {
                console.error("Failed to load sessions:", error);
                const selector = document.getElementById('sessionSelector');
                selector.innerHTML = '<option value="">Error loading sessions</option>';
            }
        }

        /**
         * Load selected session's telemetry
         */
        document.getElementById('loadSessionBtn')?.addEventListener('click', async () => {
            const sessionKey = document.getElementById('sessionSelector').value;

            if (!sessionKey) {
                alert('Please select a session');
                return;
            }

            try {
                const loadBtn = document.getElementById('loadSessionBtn');
                loadBtn.disabled = true;
                loadBtn.textContent = 'Loading...';

                // Fetch telemetry data
                const telemetryData = await openf1Loader.fetchTelemetryForSession(sessionKey);

                // Load into animator
                if (animator.loadTelemetryData(telemetryData)) {
                    console.log(`‚úì Loaded ${telemetryData.dataPoints} telemetry points`);
                    animator.start();
                } else {
                    alert('Failed to load telemetry data');
                }

                loadBtn.disabled = false;
                loadBtn.textContent = 'Load Session';

            } catch (error) {
                console.error("Error loading session:", error);
                alert(`Error loading session: ${error.message}`);
                const loadBtn = document.getElementById('loadSessionBtn');
                loadBtn.disabled = false;
                loadBtn.textContent = 'Load Session';
            }
        });
    </script>
</body>
</html>
